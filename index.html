<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>RLX - XML para Excel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #0071bc;
      --secondary: #00b050;
      --bg: #f5fafd;
      --text: #333;
    }

    body {
      background-color: var(--primary);
      font-family: 'Segoe UI', sans-serif;
      color: var(--text);
      margin: 0;
      padding: 0;
    }

    header {
      background-color: var(--primary);
      color: white;
      text-align: center;
      padding: 20px;
    }

    header img {
      height: 80px;
      margin-bottom: 10px;
    }

    header h1 {
      margin: 10px 0 0;
      color: white;
    }

    main {
      background-color: var(--bg);
      padding: 20px;
      max-width: 1000px;
      margin: auto;
      border-radius: 0 0 10px 10px;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    input[type="file"] {
      padding: 10px;
      border: 2px dashed var(--primary);
      background: #fff;
      width: 100%;
      margin-bottom: 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    button {
      background-color: var(--secondary);
      color: white;
      border: none;
      padding: 12px 20px;
      margin-top: 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background-color: #009344;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: var(--primary);
      color: white;
    }

    footer {
      text-align: center;
      font-size: 12px;
      padding: 10px;
      color: white;
    }
  </style>
</head>
<body>
  <header>
    <img src="rlxlogo.png" alt="Logo RLX">
    <h1>RLX Fluidos e Refrigerantes</h1>
    <p><strong>Conversor de XML para Excel</strong></p>
  </header>

  <main>
    <div class="card">
      <h2>1. Selecione os arquivos XML</h2>
      <input type="file" id="xmlFiles" multiple accept=".xml">
      <button onclick="processarArquivos()">Processar XMLs</button>
      <button onclick="exportarExcel()">Exportar para Excel</button>
    </div>

    <div class="card">
      <h2>2. Resultados</h2>
      <table id="tabelaResultados">
        <thead>
          <tr>
            <th>Data</th>
            <th>Nota</th>
            <th>Série</th>
            <th>CNPJ</th>
            <th>Motivo</th>
            <th>Descrição</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <footer>Produzido por Lm2 - Felipe Lima</footer>

  <script>
    let dados = [];

    function formatarData(dataISO) {
      const [ano, mes, dia] = dataISO.split("T")[0].split("-");
      return `${dia}/${mes}/${ano}`;
    }

    function processarArquivos() {
      dados = [];
      const files = document.getElementById('xmlFiles').files;
      if (!files.length) {
        alert("Selecione arquivos XML.");
        return;
      }

      let lidos = 0;
      for (const file of files) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const xml = e.target.result;
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xml, "application/xml");

          const eventos = xmlDoc.getElementsByTagName("detEvento");
          for (let i = 0; i < eventos.length; i++) {
            const cnpj = xmlDoc.getElementsByTagName("CNPJ")[0]?.textContent || '';
            const xCorrecao = eventos[i].getElementsByTagName("xCorrecao")[0]?.textContent || '';
            const descEvento = eventos[i].getElementsByTagName("descEvento")[0]?.textContent || '';
            const dhEvento = xmlDoc.getElementsByTagName("dhEvento")[0]?.textContent || '';
            const chNFe = xmlDoc.getElementsByTagName("chNFe")[0]?.textContent || '';

            const chaveFinal = chNFe.slice(-22);
            const nota = chaveFinal.slice(3, 12); // 9 dígitos
            const serie = chaveFinal.slice(0, 3);

            if (chNFe && dhEvento) {
              dados.push({
                data: formatarData(dhEvento),
                nota,
                serie,
                cnpj,
                motivo: descEvento,
                descricao: xCorrecao
              });
            }
          }

          lidos++;
          if (lidos === files.length) {
            preencherTabela();
            alert("Arquivos processados com sucesso!");
          }
        };
        reader.readAsText(file);
      }
    }

    function preencherTabela() {
      const tbody = document.querySelector("#tabelaResultados tbody");
      tbody.innerHTML = "";
      dados.sort((a, b) => {
        const da = a.data.split("/").reverse().join("-");
        const db = b.data.split("/").reverse().join("-");
        return new Date(da) - new Date(db);
      });

      for (const item of dados) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.data}</td>
          <td>${item.nota}</td>
          <td>${item.serie}</td>
          <td>${item.cnpj}</td>
          <td>${item.motivo}</td>
          <td>${item.descricao}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function exportarExcel() {
      if (!dados.length) {
        alert("Nenhum dado disponível para exportar.");
        return;
      }

      const wsData = [["Data", "Nota", "Série", "CNPJ", "Motivo", "Descrição"]];
      dados.forEach(item => {
        wsData.push([item.data, item.nota, item.serie, item.cnpj, item.motivo, item.descricao]);
      });

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Cancelamentos");
      XLSX.writeFile(wb, "notas_canceladas.xlsx");
    }
  </script>
</body>
</html>
