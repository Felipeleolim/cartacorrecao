<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>RLX - XML para Excel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #0071bc;
      --secondary: #00b050;
      --bg: #f5fafd;
      --text: #333;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background-color: var(--bg);
      font-family: 'Segoe UI', sans-serif;
      color: var(--text);
      margin: 0;
      padding: 0;
    }

    header {
      background-color: var(--primary);
      color: white;
      text-align: center;
      padding: 30px 20px;
    }

    header img {
      max-height: 80px;
      margin-bottom: 10px;
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
    }

    main {
      padding: 20px;
      max-width: 1000px;
      margin: auto;
    }

    h1, h2 {
      color: var(--primary);
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    input[type="file"] {
      padding: 10px;
      border: 2px dashed var(--primary);
      background: #fff;
      width: 100%;
      margin-bottom: 10px;
      border-radius: 5px;
      cursor: pointer;
    }

    button {
      background-color: var(--secondary);
      color: white;
      border: none;
      padding: 12px 20px;
      margin-top: 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background-color: #009344;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      text-align: left;
    }

    th {
      background-color: #e0f0ff;
    }

    footer {
      text-align: center;
      font-size: 12px;
      color: #888;
      margin: 20px 0;
    }

    @media (max-width: 600px) {
      table {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="a77d553a-a458-4e86-a05f-da962257ae5a.png" alt="RLX Logo">
    <h1 style="color: white;">RLX Fluidos e Refrigerantes</h1>
    <p><strong>Conversor de XML para Excel</strong></p>
  </header>

  <main>
    <div class="card">
      <h2>1. Selecione seus arquivos XML</h2>
      <input type="file" id="xmlFiles" multiple accept=".xml">
      <button onclick="processarArquivos()">Processar XMLs</button>
      <button onclick="exportarExcel()">Exportar para Excel</button>
    </div>

    <div class="card">
      <h2>2. Visualização dos Dados</h2>
      <table id="tabelaDados">
        <thead>
          <tr>
            <th>Data</th>
            <th>Nota</th>
            <th>Série</th>
            <th>CNPJ</th>
            <th>Motivo</th>
            <th>Descrição</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <footer>
    Produzido por Lm2 - Felipe Lima
  </footer>

  <script>
    let dados = [];

    function processarArquivos() {
      dados = [];
      const files = document.getElementById('xmlFiles').files;
      if (!files.length) {
        alert("Selecione arquivos XML.");
        return;
      }

      let lidos = 0;
      for (const file of files) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const xml = e.target.result;
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xml, "application/xml");

          const eventos = xmlDoc.getElementsByTagName("evento");

          for (let i = 0; i < eventos.length; i++) {
            const cnpj = eventos[i].getElementsByTagName("CNPJ")[0]?.textContent || "";
            const chNFe = eventos[i].getElementsByTagName("chNFe")[0]?.textContent || "";
            const descEvento = eventos[i].getElementsByTagName("descEvento")[0]?.textContent || "";
            const xCorrecao = eventos[i].getElementsByTagName("xCorrecao")[0]?.textContent || "";
            const dhEvento = eventos[i].getElementsByTagName("dhEvento")[0]?.textContent || "";

            const data = dhEvento.split("T")[0];
            const chaveFinal = chNFe.slice(-22);
            const nota = chaveFinal.slice(3, 11);
            const serie = chaveFinal.slice(0, 3);

            if (chNFe) {
              dados.push({
                data,
                nota,
                serie,
                cnpj,
                motivo: descEvento,
                descricao: xCorrecao
              });
            }
          }

          lidos++;
          if (lidos === files.length) {
            renderizarTabela();
            alert("Arquivos processados com sucesso!");
          }
        };
        reader.readAsText(file);
      }
    }

    function renderizarTabela() {
      const tbody = document.querySelector("#tabelaDados tbody");
      tbody.innerHTML = "";
      dados.sort((a, b) => a.data.localeCompare(b.data));
      dados.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.data}</td>
          <td>${d.nota}</td>
          <td>${d.serie}</td>
          <td>${d.cnpj}</td>
          <td>${d.motivo}</td>
          <td>${d.descricao}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function exportarExcel() {
      if (!dados.length) {
        alert("Nenhum dado disponível para exportar.");
        return;
      }

      const wsData = [["Data", "Nota", "Série", "CNPJ", "Motivo", "Descrição"]];
      dados.forEach(d => {
        wsData.push([d.data, d.nota, d.serie, d.cnpj, d.motivo, d.descricao]);
      });

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Notas");

      XLSX.writeFile(wb, "notas_rlx.xlsx");
    }
  </script>
</body>
</html>
